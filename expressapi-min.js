const https=require("https"),mysql=require("mysql"),fs=require("node:fs"),http=require("http"),mime=require("mime"),CryptoJS=require("crypto-js"),WebSocketServer=require("ws");class Server{constructor(t="localhost",e=3e3,s=""){this.host=t,this.port=e,this.endpoint=s,this.routes={get:{},post:{},options:{}},this.middlewares=[],this.server=http.createServer(this.requestListener)}isEmpty(t){return void 0==t||null==t||""==t.replaceAll("%20","")}get(t,e){this.routes.get[this.endpoint+t]=e,this.updateConfig()}post(t,e){this.routes.post[this.endpoint+t]=e,this.updateConfig()}options(t,e){this.routes.options[this.endpoint+t]=e,this.updateConfig()}use(t){this.middlewares.push(t),this.updateConfig()}requestListener(t,e){t.body=[],t.on("error",t=>{console.error(t)}).on("data",e=>{t.body.push(e)}).on("end",()=>{t.body=Buffer.concat(t.body).toString();try{t.body=JSON.parse(t.body)}catch{}for(let s of(e.status=function(t){return e.statusCode=t,e},e.send=function(t){t.constructor===({}).constructor?(e.setHeader("Content-Type","application/json"),e.end(JSON.stringify(t))):e.end(t)},e.sendFile=function(t){e.setHeader("Content-Type",mime.getType(t)),e.setHeader("Content-Length",fs.statSync(t).size),fs.createReadStream(t).pipe(e)},this.this.middlewares))if(!0==s(t,e))return;if("OPTIONS"==t.method)return e.status(200).end();if(t.query={},t.params={},2==t.url.split("?").length){for(let r of t.url.split("?")[1].split("&"))t.query[r.split("=")[0]]=this.this.isEmpty(r.split("=")[1])?void 0:r.split("=")[1];t.url=t.url.split("?")[0]}if(void 0==this.this.routes[t.method.toLowerCase()][t.url]){if(void 0==this.this.routes[t.method.toLowerCase()][t.url+"/"]){let o="",n=t.url.split("/").filter(t=>""!=t),i=Object.keys(this.this.routes[t.method.toLowerCase()]);for(let l=0;l<i;l++)i[l]=i[l].split("/").filter(t=>""!=t);for(let u of i)if((u=u.split("/").filter(t=>""!=t)).length==n.length){for(let h=0;h<=n.length;h++){if(h==n.length){o="/"+u.join("/");break}if(u[h]!=n[h]){if(u[h].startsWith(":")){t.params[u[h].split(":")[1]]=n[h];continue}o="",t.params={};break}}if(""!=o)return this.this.routes[t.method.toLowerCase()][o](t,e)}e.status(404).send({success:!1,error:"Endpoint not found !"})}else this.this.routes[t.method.toLowerCase()][t.url+"/"](t,e)}else this.this.routes[t.method.toLowerCase()][t.url](t,e)})}listen(t=function(){console.log(`Server listening on: http://${this.host}:${this.port}/${this.endpoint}`)}){this.server.listen(this.port,this.host,this.listenCallback,t.bind(this))}updateConfig(){this.server.this=this}}class Mysql{constructor(t){this.options=t,this.conn=mysql.createConnection(this.options),this.conn.connect(),setInterval(this.saveConn.bind(this),1e3)}async query(t,e){return new Promise((s,r)=>{this.conn.query(t,e,function(t,e){return t?r(t):s(e)})})}saveConn(){this.conn.query("SELECT 1",function(){})}}class JsonToken{constructor(t){this.secret=t}sign(t){let e=CryptoJS.enc.Utf8.parse(JSON.stringify(t));return(e=CryptoJS.enc.Base64url.stringify(e))+"."+CryptoJS.SHA256(e+this.secret)}verif(t){try{let e=CryptoJS.enc.Base64url.parse(t.split(".")[0]);if(e=JSON.parse(CryptoJS.enc.Utf8.stringify(e)),CryptoJS.SHA256(t.split(".")[0]+this.secret)==t.split(".")[1])return e;return null}catch(s){return console.log(s),null}}}class WebSocket{constructor(t,e){this.ws=new WebSocketServer.Server({port:t}),this.ws.sockets=[],this.ws.on("connection",function(t){this.sockets.push(t),t.on("message",async function(t){e(this,t.toString())}),t.on("close",function(){this.sockets=this.sockets.filter(e=>e!==t)})}),console.log("WebSocket is running on port: "+t+" ...")}}module.exports.Server=Server,module.exports.Mysql=Mysql,module.exports.JsonToken=JsonToken,module.exports.WebSocket=WebSocket,module.exports.request=function(t="http://www.exemple.com/",e=null,s=null){return e=null==e?{method:"GET",headers:{}}:e,new Promise((r,o)=>{var n;function i(t){let e="";t.on("data",function(t){e+=t}),t.on("end",function(){null!=s&&s(e),r(e)}),t.on("error",function(t){o(t)})}try{n=http.request(t,e,i)}catch{n=https.request(t,e,i)}void 0!=e.body?n.end(e.body):n.end()})},module.exports.encodeBody=function(t){let e=[];for(let s of Object.keys(t))e.push(encodeURIComponent(s)+"="+encodeURIComponent(t[s]));return e.join("&")},module.exports.isEmpty=function(t){try{if(void 0==t)return!0;if(null==t)return!0;if(typeof t!=String)return!0;else if(""==t.replaceAll(" ",""))return!0;else if(""==t.replaceAll("   ",""))return!0;else if(""==t.replaceAll("ã…¤",""))return!0;return!1}catch{return!0}},module.exports.sha256=function(t){return CryptoJS.SHA256(t).toString()},module.exports.sha512=function(t){return CryptoJS.SHA512(t).toString()},module.exports.b64UrlEncode=function(t){return CryptoJS.enc.Base64url.stringify(CryptoJS.enc.Utf8.parse(t))},module.exports.b64UrlDecode=function(t){return CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64url.parse(t))};
