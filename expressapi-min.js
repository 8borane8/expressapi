const https=require("https"),mysql=require("mysql"),fs=require("node:fs"),http=require("http"),mime=require("mime"),CryptoJS=require("crypto-js"),WebSocketServer=require("ws");class Server{constructor(a="localhost",b=3e3,c=""){this.host=a,this.port=b,this.endpoint=c,this.routes={get:{},post:{},options:{}},this.middlewares=[],this.server=http.createServer(this.requestListener)}isEmpty(a){return void 0==a||null==a||""==a.replaceAll("%20","")}get(a,b){this.routes.get[this.endpoint+a]=b,this.updateConfig()}post(a,b){this.routes.post[this.endpoint+a]=b,this.updateConfig()}options(a,b){this.routes.options[this.endpoint+a]=b,this.updateConfig()}use(a){this.middlewares.push(a),this.updateConfig()}requestListener(a,b){a.body=[],a.on("error",a=>{console.error(a)}).on("data",b=>{a.body.push(b)}).on("end",()=>{a.body=Buffer.concat(a.body).toString();try{a.body=JSON.parse(a.body)}catch{}for(let j of(b.status=function(a){return b.statusCode=a,b},b.send=function(a){a.constructor===({}).constructor?(b.setHeader("Content-Type","application/json"),b.end(JSON.stringify(a))):b.end(a)},b.sendFile=function(a){b.setHeader("Content-Type",mime.getType(a)),b.setHeader("Content-Length",fs.statSync(a).size),fs.createReadStream(a).pipe(b)},this.this.middlewares))if(!0==j(a,b))return;if("OPTIONS"==a.method)return b.status(200).end();if(a.query={},a.params={},2==a.url.split("?").length){for(let i of a.url.split("?")[1].split("&"))a.query[i.split("=")[0]]=this.this.isEmpty(i.split("=")[1])?void 0:i.split("=")[1];a.url=a.url.split("?")[0]}if(void 0==this.this.routes[a.method.toLowerCase()][a.url]){if(void 0==this.this.routes[a.method.toLowerCase()][a.url+"/"]){let f="",e=a.url.split("/").filter(a=>""!=a),g=Object.keys(this.this.routes[a.method.toLowerCase()]);for(let h=0;h<g;h++)g[h]=g[h].split("/").filter(a=>""!=a);for(let d of g)if((d=d.split("/").filter(a=>""!=a)).length==e.length)for(let c=0;c<=e.length;c++){if(c==e.length){f="/"+d.join("/");break}if(d[c]!=e[c]){if(d[c].startsWith(":")){a.params[d[c].split(":")[1]]=e[c];continue}f="",a.params={};break}}""!=f?this.this.routes[a.method.toLowerCase()][f](a,b):b.status(404).send({success:!1,error:"Endpoint not found !"})}else this.this.routes[a.method.toLowerCase()][a.url+"/"](a,b)}else this.this.routes[a.method.toLowerCase()][a.url](a,b)})}listen(a=function(){console.log("Server listening ...")}){this.server.listen(this.port,this.host,this.listenCallback,a)}updateConfig(){this.server.this=this}}class Mysql{constructor(a){this.options=a,this.conn=mysql.createConnection(this.options),this.conn.connect(),setInterval(this.saveConn,1e4)}async query(a,b){return new Promise((c,d)=>{this.conn.query(a,b,function(a,b){return a?d(a):c(b)})})}saveConn(){this.conn.query("SELECT 1")}}class JsonToken{constructor(a){this.secret=a}sign(b){let a=CryptoJS.enc.Utf8.parse(JSON.stringify(b));return(a=CryptoJS.enc.Base64url.stringify(a))+"."+CryptoJS.SHA256(a+this.secret)}verif(a){try{let b=CryptoJS.enc.Base64url.parse(a.split(".")[0]);if(b=JSON.parse(CryptoJS.enc.Utf8.stringify(b)),CryptoJS.SHA256(a.split(".")[0]+this.secret)==a.split(".")[1])return b;return null}catch(c){return console.log(c),null}}}class WebSocket{constructor(a,b){this.ws=new WebSocketServer.Server({port:a}),this.ws.sockets=[],this.ws.on("connection",function(a){this.sockets.push(a),a.on("message",async function(a){b(this,a.toString())}),a.on("close",function(){this.sockets=this.sockets.filter(b=>b!==a)})}),console.log("WebSocket is running on port: "+a+" ...")}}module.exports.Server=Server,module.exports.Mysql=Mysql,module.exports.JsonToken=JsonToken,module.exports.WebSocket=WebSocket,module.exports.request=function(b="http://www.exemple.com/",a=null,c=null){return a=null==a?{method:"GET",headers:{}}:a,new Promise((f,g)=>{var d;function e(a){let b="";a.on("data",function(a){b+=a}),a.on("end",function(){null!=c&&c(b),f(b)}),a.on("error",function(a){g(a)})}try{d=http.request(b,a,e)}catch{d=https.request(b,a,e)}void 0!=a.body?d.end(a.body):d.end()})},module.exports.encodeBody=function(a){let b=[];for(let c of Object.keys(a))b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},module.exports.sha256=function(a){return CryptoJS.SHA256(a)},module.exports.sha512=function(a){return CryptoJS.SHA512(a)},module.exports.b64UrlEncode=function(a){return CryptoJS.enc.Base64url.stringify(CryptoJS.enc.Utf8.parse(a))},module.exports.b64UrlDecode=function(a){return CryptoJS.enc.Utf8.stringify(CryptoJS.enc.Base64url.parse(a))}
